# Google SRE
大型软件系统生命周期的绝大部分都处于“使用”阶段，而非“设计”或“实现”阶段。

“错误预算”起源于这样一个理念：任何产品都不是，也不应该做到100%可靠（显然这并不适用于心脏起搏器和防抱死刹车系统等）。一般来说，任何软件系统都不应该一味地追求100%可靠。因为对最终用户来说，99.999%和100%的可用性是没有实质区别的（详见附录A）。从最终用户到服务器之间有很多中间系统（用户的笔记本电脑、家庭WiFi、网络提供商和输电线路等），这些系统综合起来可靠性要远低于99.999%。所以，在99.999%和100%之间的区别基本上成为其他系统的噪声。就算我们花费巨大精力将系统变为100%可靠也并不能给用户带来任何实质意义上的好处。

“错误预算”就是“1-可靠性目标”。如果一个服务的可靠性目标是99.99%，那么错误预算就是0.01%。这意味着产品研发部门和SRE部门可以在这个范围内将这个预算用于新功能上线或者产品的创新等任何事情。

一个缓慢的不断重启的实例要好过一个永远不重启一直泄露资源的实例；一个死掉的服务好过一个瘫痪的服务。

那么不论是从白盒监控系统还是黑盒监控系统发出都一样。最好多花一些时间监控现象，而不是原因。针对“原因”来说，应该只监控那些非常确定的和非常明确的原因。

## 自动化与消除琐事

琐事的定义：

### 错误预算

### 留出 50% 的工作开发，而不是 all in 事故处理

# 监控

服务监控的四大方向：

- 计算：CPU 占用
- 存储：内存占用、硬盘占用
- 网络：网络上下行带宽占用
- 软件异常事件：重启、OOM、Core Dump

两种监控告警方案：

- 外部黑盒监控，模仿用户访问服务的全链路
- 服务内部监控，监控业务指标数据

业务监控的四个黄金指标：

- 延迟
- 吞吐量
- 错误
- 饱和度：所有有限资源，例如：CPU、MEM、连接数等。99%的请求延迟（在某一个小的时间范围内，例如一分钟）可以作为一个饱和度早期预警的指标。

监控系统只需要三种级别的输出：

- 告警（需要介入人员脑力思考的异常才需要告警）
  
    告警一定是需要人工介入的问题，可以由系统自动处理的问题不应该发出告警。过多的无效告警会让开发者人员产生告警疲劳，从而忽略真正需要人工介入的告警。
  
    同理，业务监控指标的阈值配置也应合理，避免产生过多的伪告警。例如，有些业务逻辑会导致 CPU 短时内飙高，但是实际上是正常的业务负载，这是如果过于敏感地监控指标，则会产生大量的伪告警。

- 工单（天级别处理）
- 日志

监控的视角分为外部视角和内部视角：
- 外部视角表示从客户端调用服务得到可用性，会受限于服务内部可用性、网络链路中任何一环、用户设备等
- 内部视角指的是服务内部得到的可用性，等于成功请求/全部收到的请求，受到服务本身、依赖的下游服务、依赖组件等影响

我们不应该将监控系统中的所有指标都定义为SLI；只有理解用户对系统的真实需求才能真正决定哪些指标是否有用。指标过多会影响对那些真正重要的指标的关注，而选择指标过少则会导致某些重要的系统行为被忽略。一般来说，四五个具有代表性的指标对系统健康程度的评估和关注就足够了。常见的服务，根据它们的相关SLI通常会归类为以下几个大类。
- 用户可见的服务系统，例如莎士比亚搜索服务的前端服务器通常关心可用性、延迟，以及吞吐量。换句话说：是否能正常处理请求？每个请求花费的时间是多少？多少请求可以被处理？
- 存储系统通常强调：延迟、可用性和数据持久性。换句话说：读写数据需要多少时间？我们是否可以随时访问数据？数据是否一段时间内还能被读取？扩展讨论参见第26章。 
- 大数据系统，例如数据处理流水线系统，一般来说关心吞吐量和端到端延迟。换句话说：处理了多少数据？数据从输入到产出需要多少时间？（某些流水线任务还会关注某个单独处理阶段的延迟。）
- 所有的系统都应该关注：正确性。是否返回了正确的回复，是否读取了正确的数据，或者进行了正确的数据分析操作。正确性是系统健康程度的一个重要指标，但是它更关注系统内部的数据，而不是系统本身，所以这通常不是SRE直接负责的。

高效的警报系统应该提供足够的信息，并且误报率非常低。



# 监控系统实践

## Logging 日志

## Metrics 指标

## Tracing 链路追踪

# Ref

- [Google SRE](https://book.douban.com/subject/26875239/)