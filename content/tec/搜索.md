# 概览

本文主要介绍传统搜索的内容，即基于 elasticsearch、lucene、分词等技术构建的搜索引擎，不包含向量检索、大语言模型、RAG 等技术。

其主体架构如下：

// todo: insert architecuture here

# 召回流程

## NLU、扩召回

## 召回

一句话：从 Elasticsearch 中获取数据的过程称为「召回」。召回的过程就是根据用户的 query 和预定义的召回策略，拼接符合语义的 DSL，送到索引中获取到业务数据。

其中召回策略分为如下这些逻辑部分：
0. 权限：必备的部分，例如：用户仅可搜索自己有权限的文档
1. 用户筛选器：用户指定的筛选器，例如只搜离职人员
2. 召回策略：搜索策略，例如人名可搜、人名拼音可搜
3. 提权策略：对于特定的情况（例如拼音完全匹配），将其权重大幅度提高。

举个例子：
```json
{
    "query":{
        "filter": [
            // 权限：只搜当前用户租户的数据
            {
                "term": {
                    "tenant_id": "1234"
                }
            },
            // 用户筛选器：只搜离职人员
            {
                "term": {
                    "status": "resigned"
                }
            }
        ],
        // 召回策略
        "should": [
            {
                "match_phrase": {
                    "name.ngram": "诸葛亮" // 通过ngram达成类似模糊搜索的效果
                    "analyzer": "ngram"
                },
                "term": [
                    {
                        "name.pinyin": "zhugeliang", // 通过拼音的keyword检索达成拼音搜索的目的，该数据在索引时写入
                        "analyzer": "keyword", // 不对query进行分词
                    }, 
                    {
                        // 提权策略
                        // 完全命中了字段拼音
                        "name.pinyin_keyword": "zhugeliang",
                        "analyzer": "keyword",
                        "boost": 5
                    }
                ]
            }
        ]
    }
}
```

常见的分词器包括：
- 拼音
- 简繁转换
- 单字拆分：常配合 phrase 实现模糊检索的效果，不适用于长文本
- ik：长文本语义分词
- 驼峰、蛇形分词
- 前缀分词
- 后缀分词：常用语手机尾号、身份证尾号检索


## 粗排

所谓「粗排」就是召回阶段的排序，一般是通过 ES 的文本相关性排序来实现的。粗排可分为几种类型：文本相关性、固定提权、固定降权。

## 精排

除了在粗排中可以完全独立的进行一次排序，当前用户看到的数据也应和用户信息有关，典型的几个提权的场景：
- 用户搜索了一个自己前几个小时频繁打开的文档
- 用户搜索了最近经常发言的群聊
- 用户搜索了自己的直属 leader，尽管该 leader 有很多同名联系人，但因为组织架构关系，用户 leader 仍然应排在搜索结果的第一

这些 case 都有典型的特征，以至于不易在粗排阶段完成：
- 依赖了外部特征，包括组织架构信息、数据埋点等
- 和搜索者相关

当然，我们也可以把外部特征引入到索引内，然后通过复杂的 DSL 语句达成同样的效果，但是这对索引要求太高了，他必须存储很多和待索引数据无关的信息、需要频繁的更新、DSL 也会变得十分复杂。

所以，大多情况下，我们都会通过独立的程序实现上述复杂上下文的排序逻辑，这个过程称为「精排」。

## 分页与缓存

## 后置鉴权

## 打包

将最终要返回客户端的数据打包为客户端需要的形式，这个阶段涉及到外部数据的填充与不同结构体间的转换。例如搜索联系人并返回给端上前，需要填充对应的头像 url，则在该阶段通过组织架构服务将其头像链接填充到返回体上，最终传回给客户端渲染。

# 写入流程

## 索引设计

## 写链路

写入流程属于写数据链路，故放在最后统一阐述。

读链路相比写链路简单很多，主要有如下这些步骤：

1. 接收实体变更事件，依赖于 DB binlog 或业务系统推送
2. 触发实体更新后获取实体最新数据
3. 数据后处理
4. 写入索引

# 合规设计


